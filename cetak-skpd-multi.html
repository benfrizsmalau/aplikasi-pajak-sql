<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Cetak Gabungan SKPD/SKRD</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; }
    .dokumen-print { width: 210mm; min-height: 297mm; margin: 0 auto 20mm auto; background: #fff; padding: 24px; box-sizing: border-box; }
    .page-break { page-break-after: always; }
    @media print {
      body { background: none; }
      .page-break { display: block; page-break-after: always; }
      .no-print { display: none; }
    }
    .no-print { margin: 16px 0; text-align: center; }
  </style>
</head>
<body>
  <div class="no-print">
    <button onclick="window.print()">üñ®Ô∏è Print Semua</button>
    <button onclick="window.close()">Tutup</button>
  </div>
  <div id="container-print"></div>
  <script>
    // Ambil parameter ids dari URL
    function getIdsFromUrl() {
      const params = new URLSearchParams(window.location.search);
      const ids = params.get('ids');
      if (!ids) return [];
      return ids.split(',').map(id => id.trim()).filter(Boolean);
    }

    // Fetch semua data dari backend (sekali saja, lalu filter di frontend)
    async function fetchAllData() {
      const res = await fetch('/.netlify/functions/api');
      return await res.json();
    }

    // Render satu dokumen SKPD/SKRD (HTML string)
    function renderDokumenKetetapan(ketetapan, wp, master) {
      // Tentukan label SKPD/SKRD
      let labelSurat = 'SKRD';
      if (ketetapan.ID_Ketetapan.includes('SKPD')) labelSurat = 'SKPD';
      else if (ketetapan.ID_Ketetapan.includes('SKRD')) labelSurat = 'SKRD';
      // Data master pajak
      const namaLayanan = master ? master.NamaLayanan : ketetapan.KodeLayanan;
      // Format tanggal
      const tgl = ketetapan.TanggalKetetapan ? new Date(ketetapan.TanggalKetetapan).toLocaleDateString('id-ID') : '-';
      // Format rupiah
      const rupiah = n => new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(n || 0);
      // HTML dokumen
      return `
      <div class="dokumen-print">
        <h2 style="text-align:center; margin-bottom:0;">${labelSurat}</h2>
        <div style="text-align:center; font-size:1.1em; margin-bottom:16px;">${ketetapan.ID_Ketetapan}</div>
        <table style="width:100%; margin-bottom:16px;">
          <tr><td style="width:140px;">NPWPD</td><td>: ${ketetapan.NPWPD}</td></tr>
          <tr><td>Nama Usaha</td><td>: ${wp['Nama Usaha'] || '-'}</td></tr>
          <tr><td>Nama Pemilik</td><td>: ${wp['Nama Pemilik'] || '-'}</td></tr>
          <tr><td>Alamat</td><td>: ${wp.Alamat || '-'}</td></tr>
          <tr><td>Jenis Pajak</td><td>: ${namaLayanan}</td></tr>
          <tr><td>Masa Pajak</td><td>: ${ketetapan.MasaPajak}</td></tr>
          <tr><td>Tanggal Ketetapan</td><td>: ${tgl}</td></tr>
        </table>
        <table style="width:100%; border-collapse:collapse;">
          <tr><th style="border:1px solid #333; padding:4px;">Jumlah Pokok</th><th style="border:1px solid #333; padding:4px;">Denda</th><th style="border:1px solid #333; padding:4px;">Total Tagihan</th></tr>
          <tr>
            <td style="border:1px solid #333; padding:4px; text-align:right;">${rupiah(ketetapan.JumlahPokok)}</td>
            <td style="border:1px solid #333; padding:4px; text-align:right;">${rupiah(ketetapan.Denda)}</td>
            <td style="border:1px solid #333; padding:4px; text-align:right; font-weight:bold;">${rupiah(ketetapan.TotalTagihan)}</td>
          </tr>
        </table>
        <div style="margin-top:32px;">Catatan: ${ketetapan.Catatan || '-'}</div>
        <div style="margin-top:48px; text-align:right;">Petugas,<br><br><br>____________________</div>
      </div>
      <div class="page-break"></div>
      `;
    }

    async function main() {
      const ids = getIdsFromUrl();
      if (ids.length === 0) {
        document.getElementById('container-print').innerHTML = '<p style="text-align:center; color:#c00;">Tidak ada dokumen yang dipilih.</p>';
        return;
      }
      document.getElementById('container-print').innerHTML = '<p style="text-align:center; color:#888;">Mengambil data...</p>';
      try {
        const data = await fetchAllData();
        const ketetapanList = data.ketetapan || [];
        const wpList = data.wajibPajak || [];
        const masterList = data.masterPajak || [];
        // Filter ketetapan sesuai ids
        const dokumens = ids.map(id => {
          const ketetapan = ketetapanList.find(k => String(k.ID_Ketetapan) === String(id));
          if (!ketetapan) return `<div class='dokumen-print'><b>Data ketetapan ${id} tidak ditemukan.</b></div><div class='page-break'></div>`;
          const wp = wpList.find(w => w.NPWPD === ketetapan.NPWPD) || {};
          const master = masterList.find(m => m.KodeLayanan === ketetapan.KodeLayanan);
          return renderDokumenKetetapan(ketetapan, wp, master);
        });
        document.getElementById('container-print').innerHTML = dokumens.join('');
        setTimeout(() => window.print(), 500); // Otomatis print setelah render
      } catch (err) {
        document.getElementById('container-print').innerHTML = '<p style="text-align:center; color:#c00;">Gagal mengambil data.</p>';
      }
    }
    main();
  </script>
</body>
</html> 